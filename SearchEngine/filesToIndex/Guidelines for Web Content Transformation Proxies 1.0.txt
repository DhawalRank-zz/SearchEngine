Guidelines for Web Content Transformation Proxies 1.0code { font-family: monospace; }div.constraint,div.issue,div.note,div.notice { margin-left: 2em; }ol.enumar { list-style-type: decimal; }ol.enumla { list-style-type: lower-alpha; }ol.enumlr { list-style-type: lower-roman; }ol.enumua { list-style-type: upper-alpha; }ol.enumur { list-style-type: upper-roman; }div.exampleInner pre { margin-left: 1em;margin-top: 0em; margin-bottom: 0em}div.exampleOuter {border: 4px double gray;margin: 0em; padding: 0em}div.exampleInner { background-color: #d5dee3;border-top-width: 4px;border-top-style: double;border-top-color: #d3d3d3;border-bottom-width: 4px;border-bottom-style: double;border-bottom-color: #d3d3d3;padding: 4px; margin: 0em }div.exampleWrapper { margin: 4px }div.exampleHeader { font-weight: bold;margin: 4px}.new{background-color: #FFFF80;color: inherit;}.requirement{background-color: #DDDD80;color: inherit;border: 1px black solid;padding: 0.5em;}.requirement:before{content: "Requirement: ";font-weight: bold;}.image{text-align: center;}.flow1{font-family: monospace;font-size:smaller}.flow2{margin-left: 2em;font-family: monospace;font-size:smaller}.flow3{margin-left: 4em;font-family: monospace;font-size:smaller}pre{border:none;}Guidelines for Web Content Transformation Proxies 1.0W3C Working Group Note 26 October 2010This version:http://www.w3.org/TR/2010/NOTE-ct-guidelines-20101026/Latest version:http://www.w3.org/TR/ct-guidelines/Previous version:http://www.w3.org/TR/2010/CR-ct-guidelines-20100617/Editor:Jo Rabin, Invited Expert (and before at mTLD Top Level Domain, dotMobi)Copyright © 2010 W3C® (MIT, ERCIM, Keio), All Rights Reserved. W3C liability, trademark and document use rules apply.AbstractThis document provides guidance to Content Transformation proxies as to whether and how to transform Web content.Content Transformation proxies alter requests sent by user agents toservers and responses returned by servers so that the appearance,structure or control flow of Webapplications are modified. Content Transformation proxies are mostlyused to convert Web sites designed for desktop computers to a formsuitable for mobiledevices.Based on current practice and standards, this document specifiesmechanisms with which Content Transformation proxies should make theirpresence known to other parties, present the outcome of alterationsperformed on HTTP traffic, and react to indications set by clients orservers to constrain these alterations.The objective is to reduce undesirable effects on Web applications,especially mobile-ready ones, and to limit the diversity in the modes ofoperation of Content Transformation proxies, while at the same timeallowing proxies to alter content that would otherwise not displaysuccessfully on mobile devices.Important considerations regarding the impact on security are highlighted.Status of this DocumentThis section describes the status of this document at the time of its publication. Other documents may supersede this document. A list of current W3C publications and the latest revision of this technical report can be found in the W3C technical reports index at http://www.w3.org/TR/.This document was developed by the Mobile Web Best Practices Working Group as part of the Mobile Web Initiative.This document was expected to become a W3C Recommendation and was published as a W3C Candidate Recommendation on 17 June 2010. As of October 2010, the Mobile Web Best Practices Working Group acknowledges the lack of existing implementations. Nevertheless, it also believes that the guidelines establish a framework acceptable by all parties involved.The Mobile Web Best Practices Working Group eventually resolved to discontinue the work on this document and to publish it as a Working Group Note. The Working Group hopes that this Note may serve as a basis for discussion and negotiation among players.Other than changes to this section, the document has not changed since its publication as a W3C Candidate Recommendation. In particular, the use of normative language has been kept as-is.Comments on this document may be sent to the Working Group's public email list public-bpwg-comments@w3.org (with public archive).The public public-content-transformation-conformance@w3.org mailing-list (with public archive) that had been created to gather implementation feedback may still be used for that purpose. The Working Group also invites people willing to contribute to the test case repository to let themselves known on the public-bpwg-comments@w3.org public mailing-list, noting however that no further work is anticipated on that topic within the group as of October 2010. Please check the test case repository for up-to-date information.Publication as a Working Group Note does not imply endorsement by the W3C Membership. This is a draft document and may be updated, replaced or obsoleted by other documents at any time. It is inappropriate to cite this document as other than work in progress.This document was produced by a group operating under the 5 February 2004 W3C Patent Policy. W3C maintains a public list of any patent disclosures made in connection with the deliverables of the group; that page also includes instructions for disclosing a patent. An individual who has actual knowledge of a patent which the individual believes contains Essential Claim(s) must disclose the information in accordance with section 6 of the W3C Patent Policy.Table of Contents1 Introduction (Non-Normative)    1.1 Purpose    1.2 Audience    1.3 Scope    1.4 Principles        1.4.1 IAB Considerations        1.4.2 Priority of Intention2 Terminology (Normative)    2.1 Types of Proxy    2.2 Types of Transformation    2.3 User Interaction3 Conformance (Normative)    3.1 Classes of Product    3.2 Normative and Informative Parts    3.3 Normative Language for Conformance Requirements    3.4 Transformation Deployment Conformance4 Behavior of Components (Normative)    4.1 Proxy Forwarding of Request        4.1.1 Applicable HTTP Methods        4.1.2 no-transform directive in Request        4.1.3 Treatment of Requesters that are not Web browsers        4.1.4 Serving Cached Responses        4.1.5 Alteration of HTTP Header Field Values            4.1.5.1 Content Tasting            4.1.5.2 Avoiding "Request Unacceptable" Responses            4.1.5.3 User Selection of Restructured Experience            4.1.5.4 Sequence of Requests            4.1.5.5 Original Header Fields        4.1.6 Additional HTTP Header Fields            4.1.6.1 Proxy Treatment of Via Header Field    4.2 Proxy Forwarding of Response to User Agent        4.2.1 User Preferences        4.2.2 Receipt of Cache-Control: no-transform        4.2.3 Use of Cache-Control: no-transform        4.2.4 Server Rejection of HTTP Request        4.2.5 Receipt of Vary HTTP Header Field        4.2.6 Link to "handheld" Representation        4.2.7 WML Content        4.2.8 Proxy Decision to Transform            4.2.8.1 Alteration of Response            4.2.8.2 Link Rewriting            4.2.8.3 HTTPS Link Rewriting5 Testing (Normative)AppendicesA ReferencesB Conformance StatementC Internet Content Types associated with Mobile ContentD Internet Content Types associated with Data ContentE DOCTYPEs Associated with Mobile ContentF URI Patterns Associated with Mobile Web SitesG Summary of User Preference HandlingH Example Transformation Interactions (Non-Normative)    H.1 Basic Content Tasting by Proxy    H.2 Optimization based on Previous Server Interaction    H.3 Optimization based on Previous Server Interaction, Server has Changed itsOperation    H.4 Server Response Indicating that this Representation is Intended for the TargetDevice    H.5 Server Response Indicating that another Representation is Intended for theTarget DeviceI Informative Guidance for Origin Servers (Non-Normative)    I.1 Server Response to Proxy        I.1.1 Use of HTTP 406 Status        I.1.2 Use of HTTP 403 Status        I.1.3 Server Origination of Cache-Control: no-transform        I.1.4 Varying Representations            I.1.4.1 Use of Vary HTTP Header Field            I.1.4.2 Indication of Intended Presentation Media Type of RepresentationJ Applicability to Transforming Solutions which are Out of Scope (Non-Normative)K Scope for Future Work (Non-Normative)    K.1 POWDER    K.2 link HTTP Header Field    K.3 Sources of Device Information    K.4 Inter Proxy Communication    K.5 Explicit Consent    K.6 Amendment to and Refinement of HTTPL Acknowledgments (Non-Normative)1 Introduction (Non-Normative)1.1 PurposeWithin this document Content Transformation refers to themanipulation of requests to, and responses from, an origin server.This manipulation is carried out by proxies in order to provide abetter user experience of content that would otherwise result in anunsatisfactory experience on the device making the request.The W3C Mobile Web Best Practices Working Group neither approves nor disapproves of Content Transformation, butrecognizes that is being deployed widely across mobile data access networks. Thedeployments are widely divergent to each other, with many non-standard HTTPimplications, and no well-understood means either of identifying the presence ofsuch transforming proxies, nor of controlling their actions. This documentestablishes a framework to allow that to happen.The overall objective of this document is to provide a means, as far as ispractical, for users to be provided with at least a>"functional user experience"[Device Independence Glossary] of the Web, when mobile, taking into account thefact that an increasing number of content providers create experiences speciallytailored to the mobile context which they do not wish to be altered by thirdparties. Equally it takes into account the fact that there remain a very largenumber of Web sites that do not provide a functional userexperience when perceived on many mobile devices.It is stressed that this document is unlikely to be the last word on this topic. As noted below (1.3 Scope) it is out of scope of this document to provide a comprehensive solution to control of transforming proxies, though sucha solution would appear to be needed. The document is an attempt to improve a situation at a point in time where there appearsto be disregard of the provisions of HTTP - and is primarily a reminder and an encouragement to follow those provisions moreclosely.1.2 AudienceThe audience for this document is creators of Content Transformation proxies andpurchasers and operators of such proxies. The document also contains non-normative guidance for content providers whose servicesmay be accessed by means of such proxies.1.3 ScopeThe recommendations in this document refer only to "Web browsing" - i.e. accessby user agents that are intended primarily for interaction by users with HTMLWeb pages (Web browsers) using HTTP. Clients that interact with proxies usingmechanisms other than HTTP (and that typically involve the download of a specialclient) are out of scope, and are considered to be a distributed user agent.Proxies which are operated in the control of or under the direction of theoperator of an origin server are similarly considered to be a distributed originserver and hence out of scope.The W3C Mobile Web Best Practices Working Group (BPWG) is not chartered to create new technology - its role is to advise onbest practice for use of existing technology. In satisfying ContentTransformation requirements, existing HTTP header fields, directives and behaviorsmust be respected, and as far as is practical, no extensions to [RFC 2616 HTTP] are to be used.The recommendations in this document refer to interactions of a proxy and do not refer to any presumed aspects of the internaloperation of the proxy. For this reason, the document does not discuss use of "allow" and "disallow" lists (though it doesdiscuss behavior that is induced by the implementation of such lists). In addition it does not discuss details of how transformationis carried out except if this is reflected in interoperability. For this reason, it does not discuss the insertion or insertionof headers and footers or any other specific behaviors (though it does discuss the need for essential user interaction ofsome form).Moral, legal and other similar questions are not in scope of this document. The BPWG does not have authority or expertiseto comment one way or another about setting precedent or authorising any particular behavior or its absence.1.4 Principles1.4.1 IAB ConsiderationsThe BPWG made reference to Internet Architecture Board (IAB) work on "Open Pluggable Edge Services" [RFC 3238 OPES] for variousprinciples that underlie behavior of proxies. In this work the IAB expressed itsconcerns about privacy,control, monitoring, and accountability of such services.1.4.2 Priority of IntentionThe Web allows users considerable flexibility in respect of the representation of content. At the same time, Content Providersmay have a preferred manner in which they wish their content to be represented. Content Transformation must reconcile thesecontrasting factors. In creating this Recommendation the BPWG has determined that Content Transformation proxies should respectContent Providers intentions, where they are expressed, but may allow users to choose other representations, except whereContent Providers specifically prohibit this.The BPWG recognizes that there is neither a systematic vocabulary for Content Provider Intentions, nor a systematic meansof expression of such intentions. There is scope for further work in this area (see K Scope for Future Work).2 Terminology (Normative)2.1 Types of ProxyAlteration of HTTP requests and responses is not prohibited by HTTP other than inthe circumstances referred to in [RFC 2616 HTTP]Section 13.5.2 and Section 14.9.5.HTTP defines two types of proxy: transparent proxies and non-transparent proxies.As discussed in [RFC 2616 HTTP]Section 1.3, Terminology:>"A transparentproxy is a proxy that does not modify the request or responsebeyond what is required for proxy authentication and identification.title="non-transparent proxy">Anon-transparent proxy is a proxy that modifies the requestor response in order to provide some added service to the user agent, suchas group annotation services, media type transformation, protocol reduction,or anonymity filtering. Except where either transparent ornon-transparent behavior is explicitly stated, the HTTP proxy requirements applyto both types of proxies."This document elaborates the behavior of non-transparent proxies, when used forContent Transformation in the context discussed in [CT Landscape].>2.2 Types of TransformationTransforming proxies can carry out a wide variety of operations. In this documentwe categorize these operations as follows (noting that these are general concepts that we do not formalize further):Alteration of RequestsTransforming proxies process requests in a number of ways, especiallyreplacement of various request header fields to avoid HTTP 406 Statusresponses (if a server can not provide content that is compatible withthe original HTTP request header fields) and at user request.Alteration of ResponsesThere are three classes of operation on responses:Restructuring content>Restructuring content is a process wherebythe original layout is altered so that content is added orremoved or where the spatial or navigational relationship ofparts of content is altered, e.g. linearization(i.e. reordering presentation elements, especially tables,so that they fit on a narrow display and can be traversedwithout horizontal scrolling) or pagination(i.e. splitting a document too large to be storedin or transmitted to the terminal in one piece,so that it can be nevertheless accessed by browsingthrough a succession of smaller interlinked documents).It also includes rewriting URIs so that subsequentrequests are routed via the proxy handling the response.Recoding contentRecoding content is a process whereby thelayout of the content remains the same, but details of itsencoding may be altered. Examples include re-encoding HTMLas XHTML, correcting invalid markup in HTML, conversion ofimages between formats (but not, for example, reducinganimations to static images).Optimizing contentOptimizing content includes removing redundantwhite space, re-compressing images (without loss offidelity) and compressing for transfer.2.3 User InteractionAt various points in this document there is reference to "notifying the user", "informing the user" - in general making theuser aware that a situation exists or interacting with the user to solicit a choice of options. The expectation is that suchuser interaction is conducted in a way that allows the user to perceive and interact with such information or choices in thesame way as they interact with the Web sites that they are visiting.3 Conformance (Normative)3.1 Classes of ProductThe Content Transformation Guidelines specification has one class of products:Transformation DeploymentA Transformation Deployment is the provision of non-transparent componentsin the path of HTTP requests and responses. Provisions that areapplicable to a Transformation Deployment are identified in thisdocument by use of the term "transforming proxy" or "proxy" in thesingular or plural.id="sec-normative-and-informative-parts">3.2 Normative and Informative PartsNormative parts of this document are identified by the use of "(Normative)"following the section name. Informative parts are identified by use of"(Non-Normative)" following the section name.3.3 Normative Language for Conformance RequirementsThe key words must, must not,required, shall, shallnot, should, should not,recommended, not recommended, may, andoptional in this Recommendation have the meaning definedin [RFC 2119].id="sec-transformation-deployment-conformance">3.4 Transformation Deployment ConformanceA Transformation Deployment conforms to these guidelines if it follows thestatements in 3.4 Transformation Deployment Conformance, 4.1 Proxy Forwarding of Request, 4.2 Proxy Forwarding of Response to User Agent and 5 Testing (Normative).A Transformation Deployment that wishes to claim conformance must make available a conformance statement B Conformance Statement that specifies the reasons for non-compliance with any clauses containing the key words "should" and "should not", "recommended" and "not recommended".Conformance statements must be sent to public-content-transformation-conformance@w3.org. Public archive of this list may be found at http://lists.w3.org/Archives/Public/public-content-transformation-conformance/.4 Behavior of Components (Normative)4.1 Proxy Forwarding of Request>4.1.1 Applicable HTTP MethodsUser agents sometimes issue HTTP HEAD requests in order to determine if aresource is of a type and/or size that they are capable of handling. Atransforming proxy may convert a HEAD request into a GETrequest (in order to determine the characteristics of a transformed responsethat it would return if the user agent subsequently issued a GET request forthe same resource).If the HTTP method is altered from HEAD to GET, proxiesshould (providing such action is in accordance withnormal HTTP caching rules) cache the response so that a second GET requestfor the same content is not required (see also 4.1.4 Serving Cached Responses).Other than to convert between HEAD and GET proxies must not alter request methods.4.1.2 no-transform directive in RequestIf the request contains a Cache-Control: no-transform directive, proxies must not alter the request other than to comply with transparent HTTP behavior defined in [RFC 2616 HTTP] sections section 14.9.5 and section 13.5.2 and to add header fields as described in 4.1.6 Additional HTTP Header Fields below.Note:An example of the use of Cache-Control: no-transform is theissuing of asynchronous HTTP requests, perhaps by means ofXMLHttpRequest [XHR], which may include such adirective in order to prevent transformation of both the request and theresponse.4.1.3 Treatment of Requesters that are not Web browsersBefore altering aspects of HTTP requests and responses proxies need to take account of the fact that HTTP is used as a transportmechanism for many applications other than "Traditional Browsing". Increasingly browser based applications involve exchangesof data using XMLHttpRequest (see 4.2.8 Proxy Decision to Transform) and alteration of such exchanges is likely to cause misoperation.>4.1.4 Serving Cached ResponsesAside from the usual caching procedures defined in [RFC 2616 HTTP], in some circumstances, proxies may paginate responses andwhere this is the case a request may be for a subsequent page of apreviously requested resource. In this case proxies mayfor the sake of consistency of representation serve stale data but whendoing so should notify the user that this is the case andmust provide a simple means of retrieving a freshcopy.4.1.5 Alteration of HTTP Header Field ValuesOther than the modifications required by [RFC 2616 HTTP] proxies should not modify the values of header fields other thanthe User-Agent, Accept, Accept-Charset, Accept-Encoding, and Accept-Language header fieldsand must not delete header fields (see 4.1.5.5 Original Header Fields).Other than to comply with transparent HTTP operation, proxies should not modify any request header fields unless one of the following applies:the user would be prohibited from accessing content as a result ofthe server responding that the request is "unacceptable" (see4.2.4 Server Rejection of HTTP Request);the user has specifically requested a restructured desktopexperience (see 4.1.5.3 User Selection of Restructured Experience);the request is part of a sequence of requests comprising either included resources or linked resourceson the same Web site (see 4.1.5.4 Sequence of Requests).These circumstances are detailed in the following sections.Note:It is emphasized that requests must not be altered in the presence of Cache-Control: no-transform as described under 4.1.2 no-transform directive in Request.Note:In this section, the concept of "Web site" is used(rather than "origin server") as some origin servers host many differentWeb sites. Since the concept of "Web site" is not strictly defined,proxies should use heuristics including comparisonsof domain name to assess whether resources form part of the same "Website".Note:The URI referred to in the request plays no part indetermining whether or not to alter HTTP request header field values. Inparticular the patterns mentioned in4.2.8 Proxy Decision to Transform are not material.4.1.5.1 Content TastingWhile complying with this section (4.1.5 Alteration of HTTP Header Field Values) and section 4.2.5 Receipt of Vary HTTP Header Field proxies should avoid making repeated requests for the same resource.Note:While HTTP does not prohibit repetition of GET requests, repeated requests place an unnecessary load on the network and server.>4.1.5.2 Avoiding "Request Unacceptable" ResponsesA proxy may reissue a request with altered HTTP header fieldvalues if a previous request with unaltered values resulted in theorigin server rejecting the request as "unacceptable" (see 4.2.4 Server Rejection of HTTP Request). A proxy may apply heuristics ofvarious kinds to assess, in advance of sending unaltered header field values,whether the request is likely to cause a "request unacceptable"response. If it determines that this is likely then itmay alter header field values without sending unalteredvalues in advance, providing that it subsequently assesses the responseas described under 4.2.5 Receipt of Vary HTTP Header Field below,and is prepared to reissue the request with unaltered header fields, and alterits subsequent behavior in respect of the Web site so that unalteredheader fields are sent.A proxy must not reissue a POST request as it is unsafe (see [RFC 2616 HTTP] Section 9.1.1).4.1.5.3 User Selection of Restructured ExperienceProxies must assume that by default users will wishto receive a representation prepared by the Web site.Proxies may offer users an option to choose to view arestructured experience even when a Web site offers a choice of userexperience. If a user has made such a choice then proxiesmay alter header field values when requesting resources inorder to reflect that choice, but must, on receipt ofan indication from a Web site that it offers alternative representations(see I.1.4.2 Indication of Intended Presentation Media Type of Representation), inform the user of thatand allow them to select an alternative representation.Proxiesmust assess whether a user's expressed preferencefor a restructured representation is still valid if a Web site changesits choice of representations (see 4.2.5 Receipt of Vary HTTP Header Field).4.1.5.4 Sequence of RequestsWhen requesting resources that are>included resources (e.g. style sheets, images), proxies shouldmake the request for such resources with the same User-Agent header field as the requestfor the resource from which they are referenced.For the purpose of consistency of representation, proxiesmay request linked resources (e.g. those referencedusing the a element) that form part of the same Web site asa previously requested resource with the same header fields as the resourcefrom which they are referenced.When requesting linked resources that do not form part of the same Website as the resource from which they are linked, proxies shouldnot base their choice of header fields on a consistency ofpresentation premise.4.1.5.5 Original Header FieldsWhen forwarding an HTTP request with altered HTTP header fields, in addition to complying with the rules of normal HTTP operation,proxiesmust include in the request additional fields of the form "X-Device-"<originalheader name> whose values are verbatim copies of the correspondingunaltered header field values, so that it is possible to reconstruct the original header fields. For example, if the User-Agentheader field has been altered, an X-Device-User-Agent header fieldwould be added with the value of the receivedUser-Agent header field.Specifically the following mapping must be used:OriginalReplacementRefUser-AgentX-Device-User-AgentRFC2616 Section 14.43AcceptX-Device-AcceptRFC2616 Section 14.1Accept-CharsetX-Device-Accept-CharsetRFC2616 Section 14.2Accept-EncodingX-Device-Accept-EncodingRFC2616 Section 14.3Accept-LanguageX-Device-Accept-LanguageRFC2616 Section 14.4Note:The X-Device- prefixed header names listed in this section have been provisionally registered with IANA (see>Provisional Message Header Field Names).Note:The X-Device- prefix was chosen primarily on the basisthat this is an already existing convention. It is noted that thevalues encoded in such header fields may not ultimately derive from adevice, they are merely received fields. The treatment of receivedX-Device header fields, which may happen where there aremultiple transforming proxies, is undefined (see K Scope for Future Work).4.1.6 Additional HTTP Header FieldsIrrespective of the presence of a no-transform directive:proxies should add the IP address of the initiatorof the request to the end of a comma separated list in anX-Forwarded-For HTTP header field;proxies must (in accordance with RFC2616) include a Via HTTPheader field (see 4.1.6.1 Proxy Treatment of Via Header Field).4.1.6.1 Proxy Treatment of Via Header FieldProxies should indicate their ability to transform content by including a comment in the Via HTTPheader field consisting of the URI "http://www.w3.org/ns/ct".When forwarding Via header fields, proxies shouldnot alter them by removing comments from them.Note:According to [RFC 2616 HTTP]Section 14.45Via header field comments "may be removedby any recipient prior to forwarding the message". However, thejustification for removing such comments is based on memorylimitations of early proxies. Most modern proxies do not suffer suchlimitations.4.2 Proxy Forwarding of Response to User AgentIn the following, proxies must check for the presence of equivalent <meta http-equiv> elements in HTML content, if the relevant HTTP header field is not present.>4.2.1 User PreferencesProxies must provide a means for users to express preferences for inhibiting content transformation even when content transformation hasbeen chosen by the user as the default behavior. Those preferences must be maintained on a user by user and Web site by Web site basis.Proxies must solicit re-expression of preferences in respect of a server if the server starts to indicate that it offers varying responsesas discussed under 4.2.5 Receipt of Vary HTTP Header Field.id="sec-receipt-of-cache-control-no-transform">4.2.2 Receipt of Cache-Control: no-transformIf the response includes a Cache-Control: no-transform directivethen proxies must not alter it other than to comply withtransparent HTTP behavior as described in [RFC 2616 HTTP] Section 13.5.2 and Section 14.9.5.>4.2.3 Use of Cache-Control: no-transformProxies may use Cache-Control: no-transform to inhibit transformation by further proxies.4.2.4 Server Rejection of HTTP RequestProxies maytreat responses with an HTTP 200 Status as though they were responses withan HTTP 406 Status if it has determined that the content (e.g. "Your browseris not supported") is equivalent to a response with an HTTP 406 Status.4.2.5 Receipt of Vary HTTP Header FieldA proxy may not be carrying out content tasting as described under 4.1.5.2 Avoiding "Request Unacceptable" Responses if it anticipates receiving a "request unacceptable" response. However, if it makes a request with altered header fieldsin these circumstances, and receives a responsecontaining a Vary header field referring to one of the alteredheader fields then it should request the resource again withunaltered header fields. It should also update whatever heuristicsit uses so that unaltered header fields are presented first in subsequent requestsfor this resource.>4.2.6 Link to "handheld" RepresentationIf the response is an HTML response and it contains a <linkrel="alternate" media="handheld" /> element (and the user agent is determined as being "handheld"), a proxyshould request and process the referenced resource,unless the resource referenced is the current representation.Note:title="current representation">In this document the term current representation means a "same document reference" as defined in [RFC 3986] Section 4.4, with the addition that if a Vary HTTP header field was present on the response then it is the same representation if the values of the HTTP header fieldsof the request have not been altered.4.2.7 WML ContentIf the content is WML proxies should act in a transparent manner.Note:This does not affect the operation of proxies that are also WAP Gateways.>4.2.8 Proxy Decision to TransformIn the absence of a Vary or no-transform directive(or a meta HTTP-Equiv element containing Cache-Control:no-transform) proxies should not transform content matching any of the following rules unless the user has specifically requested transformation:the content is HTML and contains <link rel="alternate" media="handheld"/> with a reference to the current representation;the DOCTYPE of the content (if it has one) indicates XHTML-MP, XHTML Basic, WML or iMode as listed in E DOCTYPEs Associated with Mobile Content;the Content-Type has a value listed in C Internet Content Types associated with Mobile Content.the URI of the response (following redirection or as indicated by theContent-Location HTTP header field) matches a pattern listed in F URI Patterns Associated with Mobile Web Sites;the response contains a resource that is referenced as an>included resource suitable for "handheld" in a resource that was itself handled transparently;the Content-Type indicates that the content is "data" - some values are listed in D Internet Content Types associated with Data Content;a claim of mobileOK Basic [mobileOK Basic Tests] conformanceis indicated (see [mobileOK Scheme] for how such a claim may be indicated).Other factors that a proxy may take into account:The Web site (see note) has previously shown that it iscontextually aware, even if the present response does not indicatethis;the user agent has features (such as linearization or zoom, or is a desktop device using a mobile network for access) thatallow it to present the content unaltered;the response contains client side scripts that may misoperate if theresource is restructured;the response is an HTML response and it includes<link> elements specifyingalternatives according to presentation media type.4.2.8.1 Alteration of ResponseNote:Other than as noted in thissection the nature of restructuring that is carried out, any character encoding alterations and what isomitted and what is inserted is, as discussed in 1.3 Scope, out of scope of this document.If a proxy alters the response then:It must add a Warning 214 TransformationApplied HTTP header field;The altered content should validate accordingto an appropriate published formal grammar and if XML must be well-formed;It should indicate to the user that thecontent has been transformed for mobile presentation and providean option to view the original, unmodified content.4.2.8.2 Link RewritingNote:In this document two URIs have the Same-Origin if the scheme component and the host and port subcomponents, as defined in [RFC 3986], all match. Section 6 of [RFC 3986] discusses URI comparison.Some proxy deployments have to "rewrite" links in content in order for the user agent to request the referenced resourcesthrough the proxy. In so doing, proxies make unrelated resources appear as though they have the same-origin and hence there is a danger of introducing security vulnerabilities.Note:This section (on link rewriting) refers also to insertion of links, frame flattening and any other techniques that introducesthe "same-origin" issue.Note:Link rewriting is always used by CT Proxies that are accessed as an origin server initially, e.g. which provide mobile adaptedweb search and navigation to the web pages returned in the search results, or to which the browser is redirected through theCT Proxy for adaptation of a web page. Link rewriting may be used by CT Proxies acting as normal HTTP proxies (e.g. configuredor transparent) for the browser, but may not be required since all browser requests flow through the CT Proxy.Proxies must not rewrite links when content transformation is prohibited.Proxies must preserve security between requests for domains that are not same-origin in respect of cookies and scripts.4.2.8.3 HTTPS Link RewritingNote:For clarity it is emphasized that it is not possible for atransforming proxy to transform content accessed via an HTTPS linkwithout breaking end-to-end security.Interception of HTTPS and the circumstances in which it might be permissible is not a "mobile" question, as such, but is highlypertinent to this document. The BPWG is aware that interception of HTTPS happens in many networks today. Interception of HTTPSis inherently problematic and may be unsafe. The BPWG would like to refer to protocol based "two party consent" mechanisms,but such mechanisms do not exist at the time of writing of this document.The practice of intercepting HTTPS links is strongly NOT RECOMMENDED.If a proxy rewrites HTTPS links, itmust advise the user of the security implicationsof doing so and must provide the option to bypass it and to communicate with the server directly.Notwithstanding anything else in this document, proxies must not rewrite HTTPS links in the presence of a Cache-Control: no-transform directive.If a proxy rewrites HTTPS links, replacement linksmust have the scheme https.When forwarding requests originating from HTTPS links proxies must include a Via header field as discussed under 4.1.6.1 Proxy Treatment of Via Header Field.When forwarding responses from servers proxies must notify the user of invalid server certificates.5 Testing (Normative)Operators of content transformation proxies shouldmake available an interface through which the functions ofthe proxy can be exercised. The operations possiblethrough this interface must cover those necessary tosettle the outcome of all conformance statements listed insection B.The interface must be reachable from terminals withbrowsing capabilities connected to the Web via aconventional Internet access environment at the tester'spremises; accessing the interface may necessitateadjusting standard Web browsing configurationparameters -- such as specifying a proxy IP address andport on a desktop browser, or activating a WAP setting ona mobile browser.Such access must be granted under fair, reasonable and non-discriminatory conditions. Inparticular:it is available to all, worldwide, whether or not they are W3C Members;it does not impose any further conditions or restrictions on the use of anytechnology, intellectual property rights, or other restrictions on behaviour of thetester, but may include reasonable, customary terms relating to operation ormaintenance of the relationship between tester and proxy operator such as thefollowing: choice of law and dispute resolution, confidentiality of parameters toaccess the interface, disclaimer of liability.A ReferencesCT LandscapeContentTransformation Landscape 1.0, Jo Rabin, Andrew Swainston (eds), W3C WorkingGroup Note 27 October 2009 (See http://www.w3.org/TR/2009/NOTE-ct-landscape-20091027/)RFC 2119Key words for use in RFCs to IndicateRequirement Levels, , Request for Comments: 2119, S. Bradner, March 1997 (See http://www.ietf.org/rfc/rfc2119.txt)RFC 2616 HTTPHypertext Transfer Protocol --HTTP/1.1 Request for Comments: 2616, R. Fielding, J. Gettys, J. Mogul, H.Frystyk, L. Masinter, P. Leach, T. Berners-Lee, June 1999 (See http://tools.ietf.org/html/rfc2616)RFC 3986Uniform Resource Identifier (URI):Generic Syntax, Request for Comments: 3986, T. Berners-Lee, R. Fielding, L.Masinter, January 2005 (See http://tools.ietf.org/html/rfc3986)RFC 3238 OPESIAB Architectural and Policy Considerations for Open Pluggable Edge Services, Request for Comments: 3238,S. Floyd, L. Daigle, January 2002 (See http://tools.ietf.org/html/rfc3238)Device Independence GlossaryW3C Glossary of Terms for Device Independence, Rhys Lewis(ed), W3C Working Draft 18 January 2005Best PracticesMobile Web BestPractices 1.0 Basic Guidelines, Jo Rabin, Charles McCathieNevile (eds), W3CRecommendation, 29 July 2008 (See http://www.w3.org/TR/2008/REC-mobile-bp-20080729/)mobileOK Basic TestsW3C mobileOKBasic Tests 1.0, Sean Owen, Jo Rabin (eds), W3C Recommendation, 08 December 2008 (See>http://www.w3.org/TR/2008/REC-mobileOK-basic10-tests-20081208/)mobileOK SchemeW3C mobileOKScheme 1.0, Jo Rabin, Phil Archer (eds), W3C Note, 25 August 2009 (See http://www.w3.org/TR/2009/NOTE-mobileOK-20090825/)POWDER Resource GroupingProtocol for Web Description Resources (POWDER): Grouping of Resources, Phil Archer, Andrea Perego, Kevin Smith (eds), W3CRecommendation, 1 September 2009 (See http://www.w3.org/TR/2009/REC-powder-grouping-20090901/)XHRXMLHttpRequest, Anne vanKesteren (ed), W3C Candidate Recommendation 3 August 2010 (See http://www.w3.org/TR/2010/CR-XMLHttpRequest-20100803/)XMLExtensible Markup Language (XML) 1.0 (Fifth Edition), T. Bray, J. Paoli, C. Sperberg-McQueen, E. Maler, F. Yergeau (eds),W3C Recommendation, 26 November 2008. (See http://www.w3.org/TR/2008/REC-xml-20081126/)B Conformance StatementSee http://www.w3.org/TR/2010/NOTE-ct-guidelines-20101026/icsC Internet Content Types associated with Mobile ContentThis list is not exhaustive and is likely to change.application/vnd.wap.xhtml+xmltext/vnd.wap.wmlapplication/vnd.wap.wmlctext/vnd.wap.wml+xmltext/vnd.wap.wmlscriptapplication/vnd.wap.wmlscriptcimage/vnd.wap.wbmpapplication/vnd.wap.wbxmlapplication/vnd.wap.multipart.mixedapplication/vnd.wap.multipart.relatedapplication/vnd.wap.multipart.alternativeapplication/vnd.wap.multipart.form-dataimage/x-up-wpngimage/x-up-bmpD Internet Content Types associated with Data ContentThis list is not exhaustive and is likely to change.application/jsonapplication/soap+xmlapplication/soap+fastinfosetapplication/fastsoapapplication/fastinfosetE DOCTYPEs Associated with Mobile ContentThis list is not exhaustive and is likely to change.-//OMA//DTD XHTML Mobile 1.2//EN-//WAPFORUM//DTD XHTML Mobile 1.1//EN-//WAPFORUM//DTD XHTML Mobile 1.0//EN-//W3C//DTD XHTML Basic 1.1//EN-//W3C//DTD XHTML Basic 1.0//EN-//OPENWAVE//DTD XHTML 1.0//EN-//OPENWAVE//DTD XHTML Mobile 1.0//EN-//i-mode group (ja)//DTD XHTML i-XHTML (Locale/Ver.=ja/1.0) 1.0//EN-//i-mode group (ja)//DTD XHTML i-XHTML (Locale/Ver.=ja/1.1) 1.0//EN-//i-mode group (ja)//DTD XHTML i-XHTML (Locale/Ver.=ja/2.0) 1.0//EN-//i-mode group (ja)//DTD XHTML i-XHTML (Locale/Ver.=ja/2.1) 1.0//EN-//i-mode group (ja)//DTD XHTML i-XHTML (Locale/Ver.=ja/2.2) 1.0//EN-//i-mode group (ja)//DTD XHTML i-XHTML (Locale/Ver.=ja/2.3) 1.0//EN-//W3C//DTD Compact HTML 1.0 Draft//EN-//BBSW//DTD Compact HTML 2.0//EN-//WAPFORUM//DTD WML 1.0//EN-//WAPFORUM//DTD WML 1.1//EN-//WAPFORUM//DTD WML 1.2//EN-//WAPFORUM//DTD WML 1.3//EN-//WAPFORUM//DTD WML 2.0//EN-//PHONE.COM//DTD WML 1.1//EN-//OPENWAVE.COM//DTD WML 1.3//ENF URI Patterns Associated with Mobile Web SitesUsing the notation defined in [POWDER Resource Grouping]:<iriset><includehosts>mobi</includehosts></iriset>G Summary of User Preference HandlingUser expression of preferences is referred to in several sections in this document. Those sections are:1.4.2 Priority of Intention4.1.4 Serving Cached Responses4.1.5.3 User Selection of Restructured Experience4.2.1 User Preferences4.2.2 Receipt of Cache-Control: no-transform4.2.8 Proxy Decision to Transform4.2.8.1 Alteration of Response4.2.8.3 HTTPS Link RewritingUser preferences are also referred to non-normatively under I.1.4 Varying Representations.H Example Transformation Interactions (Non-Normative)Note:The following examples refer to requests with the GET method.H.1 Basic Content Tasting by ProxyRequest resource with original header fieldsIf the response is a 406 response:If the response contains Cache-Control:no-transform, forward itOtherwise request again with altered header fieldsIf the response is a 200 response:If the response contains Vary: User-Agent, anappropriate link element or header field, or Cache-Control:no-transform, forward itOtherwise assess whether the 200 response is a form of "RequestUnacceptable"If it is not, forward itIf it is, request again with altered header fields>H.2 Optimization based on Previous Server InteractionProxy receives a request for resource P that it has notencountered beforeProxy forwards this requestResponse is 200 OK containing the text "Unsupported browser.Please get a different one or use a CT proxy."Proxy determines that this equates to a 406 Status andrequests the resource from the origin server again with altered header fields(emulating a well known desktop browser)Response is a desktop oriented representation of the resourceProxy transforms this response into content that the user agentcan display well and forwards itProxy receives a further request for the resource PBased on evidence from the previous interaction (e.g. that therewas no Vary header field, that the response was not targeted at onlythe previous user in that there was no Cache-Control: privatedirective) the CT proxy forwards the request with altered header fieldsResponse is a desktop oriented representation of the resourceProxy transforms this response into content that the user agentcan display well and forwards itH.3 Optimization based on Previous Server Interaction, Server has Changed itsOperationProxy receives a request for resource P, that it has previouslyencountered as in H.2 Optimization based on Previous Server InteractionProxy forwards request with altered header fieldsResponse is 200 OK containing a Vary: User-Agentheader fieldProxy notices that behavior has changed and reissues the requestwith original header fieldsResponse is 200 OK and proxy forwards itH.4 Server Response Indicating that this Representation is Intended for the TargetDeviceProxy receives a request for resource PProxy forwards request with original header fieldsResponse is 200 OK with Vary: User-Agent and<link type="alternate" media="handheld" href="P#id"/> where id is a document local referenceProxy forwards response as designed specifically for therequesting deviceH.5 Server Response Indicating that another Representation is Intended for the Target DeviceProxy receives a request for resource PProxy forwards request with original header fieldsResponse is 200 OK with <link type="alternate"media="handheld" href="Q" /> and Q is not PProxy requests Q with original header fieldsResponse is 200 OK and proxy forwards itI Informative Guidance for Origin Servers (Non-Normative)Content providers may wish to follow these procedures in order to improve interoperability.I.1 Server Response to ProxyI.1.1 Use of HTTP 406 StatusServers should consider using an HTTP 406 Status (and not anHTTP 200 Status) if a request cannot be satisfied with content that meetsthe criteria specified by values of the HTTP request header fields. However, some browsers do not display the content of HTTP406 Status responses.I.1.2 Use of HTTP 403 StatusServers should consider using an HTTP 403 Status if concerned that the security of a link assumed to be private has been compromised(for example this may be inferred by the presence of a Via HTTP header field in an HTTPS request).>I.1.3 Server Origination of Cache-Control: no-transformServers should consider including a Cache-Control:no-transform directive if one is received in the HTTP request, as it may be an indication that the client does not wish to receive a transformedresponse.Include a Cache-Control:no-transform directive if, for any reason,transformation of the response is prohibited.Note:Including a Cache-Control:no-transform directive can disrupt the behavior of WAP Gateways,because it can inhibit such proxies from converting WML toWMLC.Including such a directive may also disrupt the behavior of a proxy based accessibility solution.>I.1.4 Varying RepresentationsIt is good practice to take account of user agent capabilities andformulate an appropriate experience according to those capabilities. It is good practice to provide a means for users toselect amongavailable representations, to default to the lastselected representation and to provide a means ofchanging the selection.I.1.4.1 Use of Vary HTTP Header FieldIf a server varies its representation according to examination ofreceived HTTP header fields then [RFC 2616 HTTP] describes how to use the Vary header field to indicate this.Servers that are aware of the presence of a transforming proxy, as identified by aVia HTTP Header field might alter their responses according to their knowledge of specific proxy behavior. When doing so it isgood practice to make sure that theInternet content type for a response is correct for the actual content (e.g. a server shouldnot choose Content-Type: application/vnd.wap.xhtml+xmlbecause it suspects that proxies will not transformcontent of this type, if its content is not valid XHTML-MP).I.1.4.2 Indication of Intended Presentation Media Type of RepresentationIf a server has distinct representations that vary according to thetarget presentation media type, it can inhibittransformation of the response by including a Cache-Control:no-transform directive (see I.1.3 Server Origination of Cache-Control: no-transform).In addition, in HTML content it can indicate the medium forwhich the representation is intended by including a linkelement identifying in its media attribute the targetpresentation media types of this representation and setting thehref attribute to "Same-Document Reference" (see [RFC 3986] section 4.4) and in particular an empty href attribute is a "Same Document Reference".In addition it is good practice to include linkelements identifying the target presentation media types of otheravailable representations in a similar manner.If content for more than one presentation media type is served from the same URI, it is better not to use a link element identifyingthe presentation media types as the URI will appear to be a "same document reference", indicating to a client that this representationis suitable for all the named presentation media types. Instead, use a Vary HTTP header field indicating that the response varies according to the received User-Agent HTTP header field.Note:Some examples of the use of the link element areincluded above in H Example Transformation Interactions.J Applicability to Transforming Solutions which are Out of Scope (Non-Normative)There are a number of well-known examples of solutions that seem to their users asthough they are using a browser, but because the client software communicatesusing proprietary protocols and techniques, it is the combination of the client andthe network component that is regarded as the HTTP User Agent. The communicationbetween the client and the network component is therefore out of scope of thisdocument.Additionally, where some kind of administrative arrangement exists between atransforming proxy and an origin server for the purposes of transforming content onthe origin server's behalf, this is also out of scope of this document.In both of the above cases, it is good practice to adhere to the provisions of this document inrespect of providing information about the device and the original IP address.K Scope for Future Work (Non-Normative)K.1 POWDERThe BPWG believes that POWDERwill represent a powerful mechanism by whicha server may express transformation preferences. Future work in this area mayrecommend the use of POWDER to provide a mechanism for origin servers toindicate more precisely which alternatives they have and what transformationthey are willing to allow on them, and in addition to provide for ContentTransformation proxies to indicate which services they are able to perform.K.2 link HTTP Header FieldThe BPWG believes that the link HTTP header field which was removed fromHTTP/1.1, and which is under discussion for reintroduction, wouldrepresent a more general and flexible mechanism than use of the HTMLlink element, as discussed in this recommendation.K.3 Sources of Device InformationThe process of adapting content at the origin server, or transforming it in aproxy is likely to have a dependency on a repository of device descriptions. Anorigin server's willingness to allow a transforming proxy to transform contentmay depend on its evaluation of the trustworthiness of device description datathat is being used. There is scope for enhancement of the trust relationship bysome means of indicating this.K.4 Inter Proxy CommunicationThere is scope for further work to define how multiple proxies may interoperate.A common case of multiple proxies is where a network provider transforming proxyand a search engine transforming proxy are both present.K.5 Explicit ConsentRobust mechanisms are needed for indicating consent to or prohibition of transformation operations of various kinds, especiallyHTTPS link rewriting (see 4.2.8.3 HTTPS Link Rewriting).K.6 Amendment to and Refinement of HTTPThe BPWG believes that amendments to HTTP are needed to improve the interoperability of transforming proxies. For example,HTTP does not provide a way todistinguish between prohibition of any kind of transformation and theprohibition only of restructuring (and not recoding or compression).At present HTTP does not provide a mechanism for communicating original header fieldvalues. The scheme based on X-Deviceprefixed fields described under 4.1.5 Alteration of HTTP Header Field Values recordsand clarifies an approach used to achieve this effect by some contenttransformation proxies. This scheme relies upon non-standard HTTP header fields which have been provisionally registered withIANA. While the mechanism defined in that section, based oncurrent practice, applies to conforming transformation proxy deployments, it is possible that in future, in collaborationwith the IETF, thisapproach will be reconsidered. This implies that the specified X-Deviceprefixed fields may, at some time, become deprecated in favor of newequivalent fields, or that an entirely different approach will be takento representing such values.A number of mechanisms exist in HTTP which might be exploited given more precisedefinition of their operation - for example the OPTIONS method andthe HTTP 300 (Multiple Choices) Status.L Acknowledgments (Non-Normative)The editor acknowledges contributions of various kinds from members of the Mobile Web Best Practices Working Group and earlier from theContent Transformation Task Force of that group.The editor acknowledges significant written contributions from:François Daoust (Task Force Leader), W3CMagnus Lönnroth, Ericsson (and previously at Drutt)Bryan Sullivan, AT&TSean Patterson, NovarraAaron Kemp, GoogleRob Finean, OpenwaveHeiko Gerlach, VodafoneMartin Jones, VolantisTom Hume, W3C Invited ExpertEduardo Casais, W3C Invited Expert