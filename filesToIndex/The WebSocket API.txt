The WebSocket APIpre { margin-left: 2em; white-space: pre-wrap; }h2 { margin: 3em 0 1em 0; }h3 { margin: 2.5em 0 1em 0; }h4 { margin: 2.5em 0 0.75em 0; }h5, h6 { margin: 2.5em 0 1em; }h1 + h2, h1 + h2 + h2 { margin: 0.75em 0 0.75em; }h2 + h3, h3 + h4, h4 + h5, h5 + h6 { margin-top: 0.5em; }p { margin: 1em 0; }hr:not(.top) { display: block; background: none; border: none; padding: 0; margin: 2em 0; height: auto; }dl, dd { margin-top: 0; margin-bottom: 0; }dt { margin-top: 0.75em; margin-bottom: 0.25em; clear: left; }dt + dt { margin-top: 0; }dd dt { margin-top: 0.25em; margin-bottom: 0; }dd p { margin-top: 0; }dd dl + p { margin-top: 1em; }dd table + p { margin-top: 1em; }p + * > li, dd li { margin: 1em 0; }dt, dfn { font-weight: bold; font-style: normal; }i, em { font-style: italic; }dt dfn { font-style: italic; }pre, code { font-size: inherit; font-family: monospace; font-variant: normal; }pre strong { color: black; font: inherit; font-weight: bold; background: yellow; }pre em { font-weight: bolder; font-style: normal; }@media screen { code { color: orangered; } code :link, code :visited { color: inherit; } }var sub { vertical-align: bottom; font-size: smaller; position: relative; top: 0.1em; }table { border-collapse: collapse; border-style: hidden hidden none hidden; }table thead, table tbody { border-bottom: solid; }table tbody th:first-child { border-left: solid; }table tbody th { text-align: left; }table td, table th { border-left: solid; border-right: solid; border-bottom: solid thin; vertical-align: top; padding: 0.2em; }blockquote { margin: 0 0 0 2em; border: 0; padding: 0; font-style: italic; }.bad, .bad *:not(.XXX) { color: gray; border-color: gray; background: transparent; }.matrix, .matrix td { border: none; text-align: right; }.matrix { margin-left: 2em; }.dice-example { border-collapse: collapse; border-style: hidden solid solid hidden; border-width: thin; margin-left: 3em; }.dice-example caption { width: 30em; font-size: smaller; font-style: italic; padding: 0.75em 0; text-align: left; }.dice-example td, .dice-example th { border: solid thin; width: 1.35em; height: 1.05em; text-align: center; padding: 0; }.toc dfn, h1 dfn, h2 dfn, h3 dfn, h4 dfn, h5 dfn, h6 dfn { font: inherit; }img.extra, p.overview { float: right; }pre.idl { border: solid thin; background: #EEEEEE; color: black; padding: 0.5em 1em; position: relative; }pre.idl :link, pre.idl :visited { color: inherit; background: transparent; }pre.idl::before { content: "IDL"; font: bold small sans-serif; padding: 0.5em; background: white; position: absolute; top: 0; margin: -1px 0 0 -4em; width: 1.5em; border: thin solid; border-radius: 0 0 0 0.5em }pre.css { border: solid thin; background: #FFFFEE; color: black; padding: 0.5em 1em; }pre.css:first-line { color: #AAAA50; }dl.domintro { color: green; margin: 2em 0 2em 2em; padding: 0.5em 1em; border: none; background: #DDFFDD; }hr + dl.domintro, div.impl + dl.domintro { margin-top: 2.5em; margin-bottom: 1.5em; }dl.domintro dt, dl.domintro dt * { color: black; text-decoration: none; }dl.domintro dd { margin: 0.5em 0 1em 2em; padding: 0; }dl.domintro dd p { margin: 0.5em 0; }dl.domintro:before { display: table; margin: -1em -0.5em -0.5em auto; width: auto; content: 'This box is non-normative. Implementation requirements are given below this box.'; color: black; font-style: italic; border: solid 2px; background: white; padding: 0 0.25em; }dl.switch { padding-left: 2em; }dl.switch > dt { text-indent: -1.5em; }dl.switch > dt:before { content: '\21AA'; padding: 0 0.5em 0 0; display: inline-block; width: 1em; text-align: right; line-height: 0.5em; }dl.triple { padding: 0 0 0 1em; }dl.triple dt, dl.triple dd { margin: 0; display: inline }dl.triple dt:after { content: ':'; }dl.triple dd:after { content: '\A'; white-space: pre; }.diff-old { text-decoration: line-through; color: silver; background: transparent; }.diff-chg, .diff-new { text-decoration: underline; color: green; background: transparent; }a .diff-new { border-bottom: 1px blue solid; }h2 { page-break-before: always; }h1, h2, h3, h4, h5, h6 { page-break-after: avoid; }h1 + h2, hr + h2.no-toc { page-break-before: auto; }p > span:not([title=""]):not([class="XXX"]):not([class="impl"]):not([class="note"]),li > span:not([title=""]):not([class="XXX"]):not([class="impl"]):not([class="note"]) { border-bottom: solid #9999CC; }div.head { margin: 0 0 1em; padding: 1em 0 0 0; }div.head p { margin: 0; }div.head h1 { margin: 0; }div.head .logo { float: right; margin: 0 1em; }div.head .logo img { border: none } /* remove border from top image */div.head dl { margin: 1em 0; }div.head p.copyright, div.head p.alt { font-size: x-small; font-style: oblique; margin: 0; }body > .toc > li { margin-top: 1em; margin-bottom: 1em; }body > .toc.brief > li { margin-top: 0.35em; margin-bottom: 0.35em; }body > .toc > li > * { margin-bottom: 0.5em; }body > .toc > li > * > li > * { margin-bottom: 0.25em; }.toc, .toc li { list-style: none; }.brief { margin-top: 1em; margin-bottom: 1em; line-height: 1.1; }.brief li { margin: 0; padding: 0; }.brief li p { margin: 0; padding: 0; }.category-list { margin-top: -0.75em; margin-bottom: 1em; line-height: 1.5; }.category-list::before { content: '\21D2\A0'; font-size: 1.2em; font-weight: 900; }.category-list li { display: inline; }.category-list li:not(:last-child)::after { content: ', '; }.category-list li > span, .category-list li > a { text-transform: lowercase; }.category-list li * { text-transform: none; } /* don't affect nested in */.XXX { color: #E50000; background: white; border: solid red; padding: 0.5em; margin: 1em 0; }.XXX > :first-child { margin-top: 0; }p .XXX { line-height: 3em; }.annotation { border: solid thin black; background: #0C479D; color: white; position: relative; margin: 8px 0 20px 0; }.annotation:before { position: absolute; left: 0; top: 0; width: 100%; height: 100%; margin: 6px -6px -6px 6px; background: #333333; z-index: -1; content: ''; }.annotation :link, .annotation :visited { color: inherit; }.annotation :link:hover, .annotation :visited:hover { background: transparent; }.annotation span { border: none ! important; }.note { color: green; background: transparent; font-family: sans-serif; }.warning { color: red; background: transparent; }.note, .warning { font-weight: bolder; font-style: italic; }.note em, .warning em, .note i, .warning i { font-style: normal; }p.note, div.note { padding: 0.5em 2em; }span.note { padding: 0 2em; }.note p:first-child, .warning p:first-child { margin-top: 0; }.note p:last-child, .warning p:last-child { margin-bottom: 0; }.warning:before { font-style: normal; }p.note:before { content: 'Note: '; }p.warning:before { content: '\26A0 Warning! '; }.bookkeeping:before { display: block; content: 'Bookkeeping details'; font-weight: bolder; font-style: italic; }.bookkeeping { font-size: 0.8em; margin: 2em 0; }.bookkeeping p { margin: 0.5em 2em; display: list-item; list-style: square; }.bookkeeping dt { margin: 0.5em 2em 0; }.bookkeeping dd { margin: 0 3em 0.5em; }h4 { position: relative; z-index: 3; }h4 + .element, h4 + div + .element { margin-top: -2.5em; padding-top: 2em; }.element {background: #EEEEFF;color: black;margin: 0 0 1em 0.15em;padding: 0 1em 0.25em 0.75em;border-left: solid #9999FF 0.25em;position: relative;z-index: 1;}.element:before {position: absolute;z-index: 2;top: 0;left: -1.15em;height: 2em;width: 0.9em;background: #EEEEFF;content: ' ';border-style: none none solid solid;border-color: #9999FF;border-width: 0.25em;}.example { display: block; color: #222222; background: #FCFCFC; border-left: double; margin-left: 2em; padding-left: 1em; }td > .example:only-child { margin: 0 0 0 0.1em; }ul.domTree, ul.domTree ul { padding: 0 0 0 1em; margin: 0; }ul.domTree li { padding: 0; margin: 0; list-style: none; position: relative; }ul.domTree li li { list-style: none; }ul.domTree li:first-child::before { position: absolute; top: 0; height: 0.6em; left: -0.75em; width: 0.5em; border-style: none none solid solid; content: ''; border-width: 0.1em; }ul.domTree li:not(:last-child)::after { position: absolute; top: 0; bottom: -0.6em; left: -0.75em; width: 0.5em; border-style: none none solid solid; content: ''; border-width: 0.1em; }ul.domTree span { font-style: italic; font-family: serif; }ul.domTree .t1 code { color: purple; font-weight: bold; }ul.domTree .t2 { font-style: normal; font-family: monospace; }ul.domTree .t2 .name { color: black; font-weight: bold; }ul.domTree .t2 .value { color: blue; font-weight: normal; }ul.domTree .t3 code, .domTree .t4 code, .domTree .t5 code { color: gray; }ul.domTree .t7 code, .domTree .t8 code { color: green; }ul.domTree .t10 code { color: teal; }body.dfnEnabled dfn { cursor: pointer; }.dfnPanel {display: inline;position: absolute;z-index: 10;height: auto;width: auto;padding: 0.5em 0.75em;font: small sans-serif, Droid Sans Fallback;background: #DDDDDD;color: black;border: outset 0.2em;}.dfnPanel * { margin: 0; padding: 0; font: inherit; text-indent: 0; }.dfnPanel :link, .dfnPanel :visited { color: black; }.dfnPanel p { font-weight: bolder; }.dfnPanel * + p { margin-top: 0.25em; }.dfnPanel li { list-style-position: inside; }#configUI { position: absolute; z-index: 20; top: 10em; right: 1em; width: 11em; font-size: small; }#configUI p { margin: 0.5em 0; padding: 0.3em; background: #EEEEEE; color: black; border: inset thin; }#configUI p label { display: block; }#configUI #updateUI, #configUI .loginUI { text-align: center; }#configUI input[type=button] { display: block; margin: auto; }fieldset { margin: 1em; padding: 0.5em 1em; }fieldset > legend + * { margin-top: 0; }fieldset > :last-child { margin-bottom: 0; }fieldset p { margin: 0.5em 0; }function getCookie(name) {var params = location.search.substr(1).split("&");for (var index = 0; index < params.length; index++) {if (params[index] == name)return "1";var data = params[index].split("=");if (data[0] == name)return unescape(data[1]);}var cookies = document.cookie.split("; ");for (var index = 0; index < cookies.length; index++) {var data = cookies[index].split("=");if (data[0] == name)return unescape(data[1]);}return null;}The WebSocket APIW3C Candidate Recommendation 20 September 2012This Version:http://www.w3.org/TR/2012/CR-websockets-20120920/Latest Published Version:http://www.w3.org/TR/websockets/Latest Editor's Draft:http://dev.w3.org/html5/websockets/Previous Versions:http://www.w3.org/TR/2012/WD-websockets-20120809/http://www.w3.org/TR/2012/WD-websockets-20120524/http://www.w3.org/TR/2011/CR-websockets-20111208/http://www.w3.org/TR/2011/WD-websockets-20110929/http://www.w3.org/TR/2011/WD-websockets-20110419/http://www.w3.org/TR/2009/WD-websockets-20090423/http://www.w3.org/TR/2009/WD-websockets-20091029/Editor:Ian Hickson, Google, Inc.Copyright© 2012Web Consortium">W3C® (Institute of Technology">MIT,Consortium for Informatics and Mathematics">ERCIM, Keio), All Rights Reserved. W3Cliability,trademarkand documentuse rules apply.The bulk of the text of this specification is alsoavailable in the WHATWG Web Applications 1.0 specification, under a license that permitsreuse of the specification text.AbstractThis specification defines an API that enables Web pages to usethe WebSocket protocol (defined by the IETF) for two-waycommunication with a remote host.Status of This documentThis section describes the status of this document at thetime of its publication. Other documents may supersede thisdocument. A list of current W3C publications and thelatestrevision of this technical report can be found in the W3C technical reports index athttp://www.w3.org/TR/.If you wish to make comments regarding this document in a mannerthat is tracked by the W3C, please submit them via using ourpublic bug database. If you do not have an account then you canenter feedback using this form:Feedback CommentsPlease enter your feedback, carefullyindicating the title of the section for which you are submittingfeedback, quoting the text that's wrong today if appropriate. Ifyou're suggesting a new feature, it's really important to saywhat the problem you're trying to solve is. That's moreimportant than the solution, in fact.Please don't use section numbers as these tend tochange rapidly and make your feedback harder to understand.function checkFeedbackForm(form) {if (form.elements.text.value.match(/^ *alert('Please don\'t start your feedback with an angle bracket, instead explain what topic your feedback is about first.');return true;} else if (form.elements.text.value.match(/ [^ ]+ [^ ]+ [^ ]+ [^ ]+ /)) {if (form.elements.text.value.match(/^Please enter your feedback, carefully/)) {alert('Please enter your feedback, explaining what is wrong, and without repeating the instructions. Thanks!');return true;} else if (form.elements.text.value.match(/ [^ ]+ [^ ]+ [^ ]+ [^ ]+ /)) {form.action = "http://www.whatwg.org/specs/web-apps/current-work/file-bug.cgi";return true;} else {alert('Please include significantly more detail about exactly what problem you are trying to solve.');return false;}}}(Note: Your IP address and user agent will be publicly recorded for spam prevention purposes.)You can also e-mail feedback to public-webapps@w3.org (subscribe,archives),or whatwg@whatwg.org (subscribe,archives).All feedback is welcome.Notifications of changes to this specification are sent alongwith notifications of changes to related specifications using thefollowing mechanisms:E-mail notifications of changesCommit-Watchers mailing list (complete source diffs): http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.orgBrowsable version-control record of all changes:CVSWeb interface with side-by-side diffs: http://dev.w3.org/cvsweb/html5/Annotated summary with unified diffs: http://html5.org/tools/web-apps-trackerRaw Subversion interface: svn checkout http://svn.whatwg.org/webapps/The W3C Web ApplicationsWorking Group is the W3C working group responsible for thisspecification's progress along the W3C Recommendation track.This specification is the 20 September 2012 Candidate Recommendation.Comments and bugs submitted against the09 August 2012 Last Call Working Draftare tracked in acomment tracking document.Publication as a Candidate Recommendation does not imply endorsement by the W3C Membership. This is a draft document and may be updated, replaced or obsoleted by other documents at any time. It is inappropriate to cite this document as other than work in progress.This specification is being developed in conjunction with anRFC for a wire protocol, the WebSocket Protocol,available from the following location:RFC 6455: The WebSocket Protocol: http://tools.ietf.org/html/rfc6455This document was produced by a group operating under the 5February 2004 W3C Patent Policy. W3C maintains a public list ofany patent disclosures made in connection with the deliverablesof the group; that page also includes instructions for disclosing apatent. An individual who has actual knowledge of a patent which theindividual believes contains EssentialClaim(s) must disclose the information in accordance with section6 of the W3C Patent Policy.Candidate Recommendation Exit CriteriaTo exit the Candidate Recommendation (CR) stage, the following criteriamust have been met:There will be at least two interoperable implementations passing allapproved test cases in thetest suitefor this specification. An implementation is to be available (i.e. fordownload), shipping (i.e. not private), and not experimental (i.e. intendedfor a wide audience). The working group will decide when the test suite isof sufficient quality to test interoperability and will produce animplementation report (hosted together with the test suite).A minimum of one month of the CR stage will have elapsed (i.e. notuntil after 18 October 2012). This is to ensure that enough time is givenfor any remaining major errors to be caught. The CR period will be extendedif implementations are slow to appear.Table of Contents1 Introduction2 Conformance requirements2.1 Dependencies3 Terminology4 The WebSocket interface5 Feedback from the protocol6 Ping and Pong frames7 Parsing WebSocket URLs8 Event definitions9 Garbage collectionReferencesAcknowledgements1 IntroductionThis section is non-normative.To enable Web applications to maintain bidirectionalcommunications with server-side processes, this specificationintroduces the WebSocket interface.This interface does not allow for raw access to theunderlying network. For example, this interface could not be used toimplement an IRC client without proxying messages through a customserver.2 Conformance requirementsAll diagrams, examples, and notes in this specification arenon-normative, as are all sections explicitly marked non-normative.Everything else in this specification is normative.The key words "MUST", "MUST NOT", "REQUIRED", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and"OPTIONAL" in the normative parts of this document are to beinterpreted as described in RFC2119. For readability, these words donot appear in all uppercase letters in this specification. [RFC2119]Requirements phrased in the imperative as part of algorithms(such as "strip any leading space characters" or "return false andabort these steps") are to be interpreted with the meaning of thekey word ("must", "should", "may", etc) used in introducing thealgorithm.Some conformance requirements are phrased as requirements onattributes, methods or objects. Such requirements are to beinterpreted as requirements on user agents.Conformance requirements phrased as algorithms or specific stepsmay be implemented in any manner, so long as the end result isequivalent. (In particular, the algorithms defined in thisspecification are intended to be easy to follow, and not intended tobe performant.)The only conformance class defined by this specification is useragents.User agents may impose implementation-specific limits onotherwise unconstrained inputs, e.g. to prevent denial of serviceattacks, to guard against running out of memory, or to work aroundplatform-specific limitations.When support for a feature is disabled (e.g. as an emergencymeasure to mitigate a security problem, or to aid in development, orfor performance reasons), user agents must act as if they had nosupport for the feature whatsoever, and as if the feature was notmentioned in this specification. For example, if a particularfeature is accessed via an attribute in a Web IDL interface, theattribute itself would be omitted from the objects that implementthat interface — leaving the attribute on the object butmaking it return null or throw an exception is insufficient.2.1 DependenciesThis specification relies on several other underlyingspecifications.HTMLMany fundamental concepts from HTML are used by thisspecification. [HTML]WebIDLThe IDL blocks in this specification use the semantics of theWebIDL specification. [WEBIDL]3 TerminologyThe construction "a Foo object", whereFoo is actually an interface, is sometimesused instead of the more accurate "an object implementing theinterface Foo".The term DOM is used to refer to the API set made available toscripts in Web applications, and does not necessarily imply theexistence of an actual Document object or of any otherNode objects as defined in the DOM Corespecifications. [DOMCORE]An IDL attribute is said to be getting when its value isbeing retrieved (e.g. by author script), and is said to besetting when a new value is assigned to it.4 The WebSocket interface[Constructor(DOMString url, optional (DOMString or DOMString[]) protocols)]interface WebSocket : EventTarget {readonly attribute DOMString url;// ready stateconst unsigned short CONNECTING = 0;const unsigned short OPEN = 1;const unsigned short CLOSING = 2;const unsigned short CLOSED = 3;readonly attribute unsigned short readyState;readonly attribute unsigned long bufferedAmount;// networkingattribute EventHandler onopen;attribute EventHandler onerror;attribute EventHandler onclose;readonly attribute DOMString extensions;readonly attribute DOMString protocol;void close([Clamp] optional unsigned short code, optional DOMString reason);// messagingattribute EventHandler onmessage;attribute DOMString binaryType;void send(DOMString data);void send(Blob data);void send(ArrayBuffer data);void send(ArrayBufferView data);};The WebSocket(url, protocols)constructor takes one or two arguments. The first argument, url, specifies the URL to which toconnect. The second, protocols, if present, iseither a string or an array of strings. If it is a string, it isequivalent to an array consisting of just that string; if it isomitted, it is equivalent to the empty array. Each string in thearray is a subprotocol name. The connection will only be establishedif the server reports that it has selected one of thesesubprotocols. The subprotocol names must all be strings that matchthe requirements for elements that comprise the value of Sec-WebSocket-Protocolheader fields as defined by the WebSocket protocol specification. [WSP]When the WebSocket() constructor is invoked, the UAmust run these steps:Parse a WebSocket URL's components from the url argument, to obtain host,port, resource name, andsecure. If this fails, throw aSyntaxError exception and abort these steps. [WSP]If secure is false but theorigin of the entry script has a schemecomponent that is itself a secure protocol, e.g. HTTPS, then throwa SecurityError exception.If port is a port to which the user agentis configured to block access, then throw aSecurityError exception. (User agents typically blockaccess to well-known ports like SMTP.)Access to ports 80 and 443 should not be blocked, including theunlikely cases when secure is false but port is 443 or secure is truebut port is 80.If protocols is absent, let protocols be an empty array.Otherwise, if protocols is present and astring, let protocols instead be an arrayconsisting of just that string.If any of the values in protocols occurmore than once or otherwise fail to match the requirements forelements that comprise the value of Sec-WebSocket-Protocolheader fields as defined by the WebSocket protocol specification,then throw a SyntaxError exception and abort thesesteps. [WSP]Let origin be theserialization of an origin">ASCII serialization of theorigin of the entry script,converted to ASCII lowercase.Return a new WebSocket object, and continuethese steps in the background (without blocking scripts).Establish a WebSocket connection given the set (host, port, resource name, secure), alongwith the protocols list, an empty list for theextensions, and origin. The headers to sendappropriate cookies must be a Cookie header whose value is thecookie-string computed from the user's cookie store and theURL url; for these purposes this isnot a "non-HTTP" API. [WSP] [COOKIES]When the user agentresponse">validates the server's response during the"establish a WebSocket connection" algorithm, if the statuscode received from the server is not 101 (e.g. it is a redirect),the user agent must fail the WebSocket connection.Following HTTP procedures here could introduceserious security problems in a Web browser context. For example,consider a host with a WebSocket server at one path and an openHTTP redirector at another. Suddenly, any script that can be givena particular WebSocket URL can be tricked into communicating to(and potentially sharing secrets with) any host on the Internet,even if the script checks that the URL has the right hostname.If the establish a WebSocket connectionalgorithm fails, it triggers the fail the WebSocketconnection algorithm, which then invokes the close theWebSocket connection algorithm, which then establishes thatthe WebSocket connection is closed, which fires the close event as described below.This constructor must be visible when the script's globalobject is either a Window object or an objectimplementing the WorkerUtils interface.The urlattribute must return the result ofurl">resolving the URL that was passed to theconstructor. (It doesn't matter what it is resolved relative to,since we already know it is an absolute URL.)The readyStateattribute represents the state of the connection. It can have thefollowing values:CONNECTING (numeric value 0)The connection has not yet been established.OPEN (numeric value 1)The WebSocket connection is established and communication is possible.CLOSING (numeric value 2)The connection is going through the closing handshake, or the close() method has been invoked.CLOSED (numeric value 3)The connection has been closed or could not be opened.When the object is created its readyState must be set toCONNECTING (0).The extensionsattribute must initially return the empty string. After theWebSocket connection is established, its value might change, asdefined below.The extensions attribute returnsthe extensions selected by the server, if any. (Currently this willonly ever be the empty string.)The protocol attributemust initially return the empty string. After the WebSocketconnection is established, its value might change, as definedbelow.The protocol attribute returns thesubprotocol selected by the server, if any. It can be used inconjunction with the array form of the constructor's second argumentto perform subprotocol negotiation.The close()method must run the following steps:If the method's first argument is present but is not aninteger equal to 1000 or in the range 3000 to 4999, throw anInvalidAccessError exception and abort thesesteps.If the method's second argument is present, then run thesesubsteps:Let raw reason be the method's secondargument.Let Unicode reason be the result ofcharacters">converting raw reason to asequence of Unicode characters.Let reason be the result of encodingUnicode reason as UTF-8.If reason is longer than 123 bytes,then throw a SyntaxError exception and abort thesesteps. [RFC3629]Run the first matching steps from the following list:If the readyStateattribute is in the CLOSING (2) or CLOSED (3) stateDo nothing.The connection is already closing or is alreadyclosed. If it has not already, a close event will eventually fire as described below.If the WebSocket connection is not yetWebSocket connection is established">established [WSP]Fail the WebSocket connection and set the readyState attribute'svalue to CLOSING (2).[WSP]The fail the WebSocket connectionalgorithm invokes the close the WebSocketconnection algorithm, which then establishes thatthe WebSocket connection is closed, which fires theclose event as described below.If the WebSocket closing handshake has not yet beenstarted">started [WSP]Start the WebSocket closing handshake and set thereadyStateattribute's value to CLOSING (2). [WSP]If the first argument is present, then the statuscode to use in the WebSocket Close message mustbe the integer given by the first argument. [WSP]If the second argument is also present, then reason must be provided in the Close messageafter the status code. [RFC3629] [WSP]The start the WebSocket closing handshakealgorithm eventually invokes the close the WebSocketconnection algorithm, which then establishes that theWebSocket connection is closed, which fires the close event as described below.OtherwiseSet the readyState attribute'svalue to CLOSING(2).The WebSocket closing handshake isstarted, and will eventually invoke the close theWebSocket connection algorithm, which will establish thatthe WebSocket connection is closed, and thus the close event will fire, as described below.The bufferedAmountattribute must return the number of bytes of application data (UTF-8text and binary data) that have been queued using send() but that, as of the lasttime the event loop started executing a task, had not yet been transmitted tothe network. (This thus includes any text sent during the executionof the current task, regardless of whether the user agent is able totransmit text asynchronously with script execution.) This does notinclude framing overhead incurred by the protocol, or buffering doneby the operating system or network hardware. If the connection isclosed, this attribute's value will only increase with each call tothe send() method (thenumber does not reset to zero once the connection closes).In this simple example, the bufferedAmountattribute is used to ensure that updates are sent either at therate of one update every 50ms, if the network can handle that rate,or at whatever rate the network can handle, if that is toofast.var socket = new WebSocket('ws://game.example.com:12010/updates');socket.onopen = function () {setInterval(function() {if (socket.bufferedAmount == 0)socket.send(getUpdateData());}, 50);};The bufferedAmountattribute can also be used to saturate the network without sendingthe data at a higher rate than the network can handle, though thisrequires more careful monitoring of the value of the attribute overtime.When a WebSocket object is created, its binaryType IDLattribute must be set to the string "blob". Ongetting, it must return the last value it was set to. On setting, ifthe new value is either the string "blob" orthe string "arraybuffer", then set the IDLattribute to this new value. Otherwise, throw aSyntaxError exception.This attribute allows authors to control how binarydata is exposed to scripts. By setting the attribute to "blob", binary data is returned in Blobform; by setting it to "arraybuffer", it isreturned in ArrayBuffer form. User agents can use thisas a hint for how to handle incoming binary data: if the attributeis set to "blob", it is safe to spool it todisk, and if it is set to "arraybuffer", it islikely more efficient to keep the data in memory. Naturally, useragents are encouraged to use more subtle heuristics to decidewhether to keep incoming data in memory or not, e.g. based on howbig the data is or how common it is for a script to change theattribute at the last minute. This latter aspect is important inparticular because it is quite possible for the attribute to bechanged after the user agent has received the data but before theuser agent has fired the event for it.The send(data) method transmits data using theconnection. If the readyState attribute isCONNECTING, it mustthrow an InvalidStateError exception. Otherwise, theuser agent must run the appropriate set of steps from the followinglist:If the argument is a stringLet data be the result ofcharacters">converting the data argument to asequence of Unicode characters. If the WebSocketconnection is established andhandshake is started">the WebSocket closing handshake has not yetstarted, then the user agent must send a WebSocketMessage comprised of data using a textframe opcode; if the data cannot be sent, e.g. because it wouldneed to be buffered but the buffer is full, the user agent mustclose the WebSocket connection with prejudice. Anyinvocation of this method with a string argument that does notthrow an exception must increase the bufferedAmountattribute by the number of bytes needed to express the argument asUTF-8. [UNICODE] [RFC3629] [WSP]If the argument is a Blob objectIf the WebSocket connection is established, and the WebSocketclosing handshake has not yet started, then the user agentmust send a WebSocket Message comprised of data using a binary frame opcode; if the datacannot be sent, e.g. because it would need to be buffered but thebuffer is full, the user agent must close the WebSocketconnection withprejudice. The data to be sent is the raw data representedby the Blob object. Anyinvocation of this method with a Blob argument thatdoes not throw an exception must increase the bufferedAmountattribute by the size of the Blob object's raw data,in bytes. [WSP] [FILEAPI]If the argument is an ArrayBuffer objectIf the WebSocket connection is established, and the WebSocketclosing handshake has not yet started, then the user agentmust send a WebSocket Message comprised of data using a binary frame opcode; if the datacannot be sent, e.g. because it would need to be buffered but thebuffer is full, the user agent must close the WebSocketconnection withprejudice. The data to be sent is the data stored in thebuffer described by the ArrayBuffer object. Any invocation ofthis method with an ArrayBuffer argument that doesnot throw an exception must increase the bufferedAmountattribute by the length of the ArrayBuffer in bytes.[WSP] [TYPEDARRAY]If the argument is an ArrayBufferView objectIf the WebSocket connection is established, and the WebSocketclosing handshake has not yet started, then the user agentmust send a WebSocket Message comprised of data using a binary frame opcode; if the datacannot be sent, e.g. because it would need to be buffered but thebuffer is full, the user agent must close the WebSocketconnection withprejudice. The data to be sent is the data stored in thesection of the buffer described by the ArrayBufferobject that the ArrayBufferView object references.Any invocationof this method with an ArrayBufferView argument thatdoes not throw an exception must increase the bufferedAmountattribute by the length of the ArrayBufferView inbytes. [WSP] [TYPEDARRAY]The following are the event handlers (and theircorresponding event handlerevent types) that must be supported, as IDL attributes, byall objects implementing the WebSocket interface:Event handler Event handler event typeonopen openonmessage messageonerror erroronclose close5 Feedback from the protocolWhen the WebSocket connection is established, the useragent must queue a task to run these steps:Change the readyState attribute'svalue to OPEN (1).Change the extensions attribute'svalue to the extensions in use, if is not the null value. [WSP]Change the protocol attribute's value tothe subprotocol in use, if is not the null value. [WSP]Act as if the user agent hadset-cookie-string">received a set-cookie-string consistingof the cookies set during the server's opening handshake,for the URL url given to the WebSocket() constructor. [COOKIES] [RFC3629] [WSP]Fire a simple event named open at the WebSocketobject.When a WebSocket message has been received with type type and data data, the useragent must queue a task to follow these steps: [WSP]If the readyStateattribute's value is not OPEN (1), then abort thesesteps.Let event be an event that uses theMessageEvent interface, with the event type message, which does not bubble, isnot cancelable, and has no default action.[HTML]Initialize event's origin attribute to theUnicodeserialization of the origin of theURL that was passed to the WebSocketobject's constructor.If type indicates that the data is Text,then initialize event's data attribute to data.If type indicates that the data is Binary,and binaryType isset to "blob", then initialize event's data attribute to a newBlob object that represents dataas its raw data. [FILEAPI]If type indicates that the data is Binary,and binaryType isset to "arraybuffer", then initialize event's data attribute to a newread-only ArrayBuffer object whose contents are data. [TYPEDARRAY]Dispatch event at theWebSocket object.User agents are encouraged to check if they canperform the above steps efficiently before they run the task,picking tasks from other task queueswhile they prepare the buffers if not. For example, if the binaryType attribute was setto "blob" when the data arrived, and the useragent spooled all the data to disk, but just before running theabove task for this particularmessage the script switched binaryType to "arraybuffer", the user agent would want to page thedata back to RAM before running this task so as to avoid stalling the mainthread while it created the ArrayBuffer object.Here is an example of how to define a handler for the message event in the case of textframes:mysocket.onmessage = function (event) {if (event.data == 'on') {turnLampOn();} else if (event.data == 'off') {turnLampOff();}};The protocol here is a trivial one, with the server just sending"on" or "off" messages.When the WebSocket closing handshake is started, the useragent must queue a task to change the readyState attribute's valueto CLOSING (2). (If theclose() method was called,the readyStateattribute's value will already be set to CLOSING (2) when this taskruns.) [WSP]When the WebSocket connection isclosed, possibly cleanly, the user agent mustqueue a task to run the following substeps:Change the readyState attribute'svalue to CLOSED(3).If the user agent was required to fail the WebSocketconnection or the WebSocket connection is closed with prejudice,fire a simple event named errorat the WebSocket object. [WSP]Create an event that uses the CloseEventinterface, with the event type close, which does not bubble, is notcancelable, has no default action, whose wasClean attribute is initialized totrue if the connection closed cleanly and falseotherwise, whose codeattribute is initialized to the WebSocket connection close code, andwhose reason attributeis initialized to the WebSocket connection close reasondecoded as UTF-8, with error handling, and dispatchthe event at the WebSocket object. [WSP]User agents must not convey any failure information to scriptsin a way that would allow a script to distinguish the followingsituations:A server whose host name could not be resolved.A server to which packets could not successfully be routed.A server that refused the connection on the specified port.A server that failed to correctly perform a TLS handshake(e.g., the server certificate can't be verified).A server that did not complete the opening handshake (e.g.because it was not a WebSocket server).A WebSocket server that sent a correct opening handshake, butthat specified options that caused the client to drop theconnection (e.g. the server specified a subprotocol that theclient did not offer).A WebSocket server that abruptly closed the connection aftersuccessfully completing the opening handshake.In all of these cases, the the WebSocket connection closecode would be 1006, as required by the WebSocket Protocolspecification. [WSP]Allowing a script to distinguish these cases would allow ascript to probe the user's local network in preparation for anattack.In particular, this means the code 1015 is not usedby the user agent (unless the server erroneously uses it in itsclose frame, of course).The task source for all taskstask">queued in this section is the WebSocket tasksource.6 Ping and Pong framesThe WebSocket protocol specification defines Ping and Pong framesthat can be used for keep-alive, heart-beats, network statusprobing, latency instrumentation, and so forth. These are notcurrently exposed in the API.User agents may send ping and unsolicited pong frames as desired,for example in an attempt to maintain local network NAT mappings, todetect failed connections, or to display latency metrics to theuser. User agents must not use pings or unsolicited pongs to aid theserver; it is assumed that servers will solicit pongs wheneverappropriate for the server's needs.7 Parsing WebSocket URLsThe steps to parse a WebSocket URL's components froma string url are as follows. These steps returneither a host, a port, aresource name, and a secureflag, or they fail.If the url string is not anabsolute URL, then fail this algorithm.Resolve the url string, with the URL character encoding set toUTF-8. [RFC3629]It doesn't matter what it is resolved relative to,since we already know it is an absolute URL at thispoint.If url does not have a <scheme> component whose value,when converted to ASCII lowercase, is either "ws" or "wss", then fail thisalgorithm.If url has a <fragment> component, then failthis algorithm.If the <scheme>component of url is "ws",set secure to false; otherwise, the <scheme> component is "wss", set secure totrue.Let host be the value of the <host> component of url, converted to ASCIIlowercase.If url has a <port> component, then let port be that component's value; otherwise, there isno explicit port.If there is no explicit port, then: ifsecure is false, let portbe 80, otherwise let port be 443.Let resource name be the value of the<path> component (which mightbe empty) of url.If resource name is the empty string,set it to a single character U+002F SOLIDUS (/).If url has a <query> component, then append asingle U+003F QUESTION MARK character (?) to resourcename, followed by the value of the <query> component.Return host, port,resource name, and secure.8 Event definitions[Constructor(DOMString type, optional CloseEventInit eventInitDict)]interface CloseEvent : Event {readonly attribute boolean wasClean;readonly attribute unsigned short code;readonly attribute DOMString reason;};dictionary CloseEventInit : EventInit {boolean wasClean;unsigned short code;DOMString reason;};The wasCleanattribute must return the value it was initialized to. When theobject is created, this attribute must be initialized to false. Itrepresents whether the connection closed cleanly or not.The codeattribute must return the value it was initialized to. When theobject is created, this attribute must be initialized to zero. Itrepresents the WebSocket connection close code provided by theserver.The reasonattribute must return the value it was initialized to. When theobject is created, this attribute must be initialized to emptystring. It represents the WebSocket connection close reason providedby the server.9 Garbage collectionA WebSocket object whose readyState attribute's valuewas set to CONNECTING(0) as of the last time the event loop startedexecuting a task must not begarbage collected if there are any event listeners registered foropen events, message events, error events, or close events.A WebSocket object whose readyState attribute's valuewas set to OPEN (1) as ofthe last time the event loop started executing a task must not be garbage collected ifthere are any event listeners registered for message events, error, or close events.A WebSocket object whose readyState attribute's valuewas set to CLOSING (2) asof the last time the event loop started executing atask must not be garbage collectedif there are any event listeners registered for error or close events.A WebSocket object withconnection is established">an established connection that hasdata queued to be transmitted to the network must not be garbagecollected. [WSP]If a WebSocket object is garbage collected while itsconnection is still open, the user agent must start theWebSocket closing handshake, with no status code for the Close message. [WSP]If a user agent is to make disappear aWebSocket object (this happens when aDocument object goes away), the user agent must followthe first appropriate set of steps from the following list:If the WebSocket connection is not yetconnection is established">established [WSP]Fail the WebSocket connection. [WSP]If the WebSocket closing handshake has not yet been started[WSP]Start the WebSocket closing handshake, with thestatus code to use in the WebSocket Close messagebeing 1001. [WSP]OtherwiseDo nothing.ReferencesAll references are normative unless marked "Non-normative".[COOKIES]HTTP State Management Mechanism, A. Barth. IETF.[DOMCORE]DOM4, A. van Kesteren. W3C.[FILEAPI]FileAPI, A. Ranganathan. W3C.[HTML]HTML5,I. Hickson. W3C.[RFC2119]Key words for use inRFCs to Indicate Requirement Levels, S. Bradner. IETF.[RFC3629]UTF-8, atransformation format of ISO 10646, F. Yergeau. IETF.[TYPEDARRAY]Typed Array Specification, D. Herman, K. Russell. Khronos.[UNICODE]The Unicode Standard. Unicode Consortium.[WEBIDL]WebIDL, C. McCormack. W3C.[WSP]The WebSocket protocol, I. Fette, A. Melnikov. IETF.AcknowledgementsFor a full list of acknowledgements, please see the HTMLspecification. [HTML]